<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Live2D Avatar</title>
  <style>
    html, body {
      background: transparent;
      overflow: hidden;
    }
    canvas {
      display: block;
      width: 100%;
      height: 100%;
      background: transparent;
    }
  </style>
</head>
<body>
<script src="https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js"></script>

<canvas id="live2d-canvas"></canvas>

<script>
  window.addEventListener('DOMContentLoaded', () => {
    console.log('üöÄ Starting Live2D application...');

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ –æ—Ç Python
    if (window.electronAPI) {
      console.log('üîå Electron API available');

      const PIXI = window.electronAPI.PIXI;
      const Live2DModel = window.electronAPI.Live2DModel;

      const loopingMotions = ['start'];

      let app = new PIXI.Application({
        view: document.getElementById("live2d-canvas"),
        transparent: true,
        autoStart: true,
        width: window.innerWidth,
        height: window.innerHeight
      });

      let model = null;

      // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥–µ–ª—å
      async function loadModel() {
        try {
          console.log('üì¶ Loading model...');

          // –î–æ–±–∞–≤–ª—è–µ–º timestamp –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
          const timestamp = new Date().getTime();
          const modelUrl = `./model/Sparkle.model3.json?t=${timestamp}`;

          console.log(`üìÑ Loading model from: ${modelUrl}`);
          const loadedModel = await Live2DModel.from(modelUrl);

          model = loadedModel;
          model.scale.set(0.15);
          model.anchor.set(0.5, 1.0);
          model.position.set(window.innerWidth / 2, window.innerHeight / 0.62);

          model.on('motionEnd', (group, index) => {
            console.log(`Motion ended: ${group}`);

            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑–∞—Ü–∏–∫–ª–∏—Ç–∏ —Ü—é –∞–Ω—ñ–º–∞—Ü—ñ—é
            if (loopingMotions.includes(group)) {
              console.log(`Looping motion: ${group}`);
              model.motion(group, undefined, PIXI.live2d.MotionPriority.FORCE);
            }
          });

          app.stage.addChild(model);
          console.log('‚úÖ Live2D model loaded successfully');

        } catch (err) {
          console.error("‚ùå Model loading error:", err);
        }
      }

      // –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
      loadModel();

      window.electronAPI.onAvatarCommand((data) => {
        console.log('üì® Received command:', data);

        if (!model) {
          console.log('‚ùå Model not ready yet');
          return;
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        if (data.param) {
          console.log(`üéØ Setting param: ${data.param.name} = ${data.param.value}`);
          try {
            model.internalModel.coreModel.setParameterValueById(data.param.name, data.param.value);
          } catch (e) {
            console.error('‚ùå Error setting param:', e);
          }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã—Ä–∞–∂–µ–Ω–∏–π
        if (data.expression) {
          model.expression(data.expression);
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ motions
        if (data.motion) {
          model.motion(data.motion, undefined, PIXI.live2d.MotionPriority.FORCE);
        }
      });
    } else {
      console.error('‚ùå Electron API not available');
    }
  });
</script>
</body>
</html>